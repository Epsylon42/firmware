#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const md5Hasher = require('md5');
const common = require('./common.js');

const ZERO_MD5 = '000000000000000000000000000000000'

const useRealData = process.argv.includes('--withMd5Sums')
const versionPropertyPrefixes = ['firmware', 'deviceProtocol', 'moduleProtocol', 'userConfig', 'hardwareConfig', 'smartMacros'];
const patchVersions = ['Major', 'Minor', 'Patch'];
const packageJson = JSON.parse(fs.readFileSync(path.join(__dirname, 'package.json')));

const versionVariables = versionPropertyPrefixes.map(versionPropertyPrefix => {
    const versionPropertyName = `${versionPropertyPrefix}Version`
    const versionPropertyValues = packageJson[versionPropertyName].split('.');
    return patchVersions.map(patchVersion => {
        const versionPropertyValue = useRealData ? versionPropertyValues.shift() : "0";
        const versionPropertyMacroName = `${versionPropertyPrefix}${patchVersion}Version`.split(/(?=[A-Z])/).join('_').toUpperCase()
        return `    #define ${versionPropertyMacroName} ${versionPropertyValue}`;
    }).join('\n') + '\n';
}).join('\n');

const gitInfo = useRealData
  ? common.getGitInfo()
  : {
      repo: '',
      tag: ''
  };

const deviceMd5Sums = packageJson.devices.map(device => {
    const md5 = useRealData
      ? calculateMd5ChecksumOfFile(path.join(__dirname, '..', device.source))
      : ZERO_MD5;

    return `    [${device.deviceId}] = "${md5}",`;
}).join('\n');

const moduleMd5Sums = packageJson.modules.map(module => {
    const md5 = useRealData
        ? calculateMd5ChecksumOfFile(path.join(__dirname, '..', module.source))
        : ZERO_MD5;

    return `    [${module.moduleId}] = "${md5}",`;
}).join('\n');

function calculateMd5ChecksumOfFile(filePath) {
    return md5Hasher(fs.readSync(filePath, {encoding: 'binary'}));
}

fs.writeFileSync(path.join(__dirname, '..', 'shared', 'versions.h'),
`// Please do not edit this file by hand!
// It is to be regenerated by /scripts/generate-versions-h.js

#ifndef __VERSIONS_H__
#define __VERSIONS_H__

// Includes:

    #include "versioning.h"
    #include "slave_protocol.h"

// Variables:

${versionVariables}

#define GIT_REPO "${gitInfo.repo}"
#define GIT_TAG "${gitInfo.tag}"

#ifdef DEVICE_ID
char const * const DeviceMD5Checksums[DEVICE_COUNT+1] = {
${deviceMd5Sums}
};
#endif


#ifdef MODULE_ID
char const * const ModuleMD5Checksums[ModuleId_AllCount] = {
${moduleMd5Sums}
};
#endif

#endif
`);
